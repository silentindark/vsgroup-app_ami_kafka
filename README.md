# app_ami_kafka

Asterisk module that publishes all AMI (Asterisk Manager Interface) events to Apache Kafka via `res_kafka`.

## Overview

This module uses an internal manager hook (`manager_custom_hook`) to capture **every** AMI event generated by Asterisk and publishes them to a configurable Kafka topic. This eliminates the need for external AMI TCP connections while providing better throughput and native thread-safety.

Each event is enriched with system identification fields (`EntityID` and `SystemName`) in the payload, and also sends **Kafka message headers** with metadata that consumers can read without parsing the payload — useful for routing, filtering, and observability.

### Output Formats

**JSON format** (`format = json`):
```json
{
  "Event": "Newchannel",
  "EntityID": "00:11:22:33:44:55",
  "SystemName": "pbx-01",
  "Privilege": "call,all",
  "Channel": "PJSIP/100-00000001",
  "ChannelState": "0",
  "ChannelStateDesc": "Down",
  "CallerIDNum": "100",
  "CallerIDName": "Alice",
  "Uniqueid": "1705312200.1"
}
```

**AMI format** (`format = ami`):
```
EntityID: 00:11:22:33:44:55
SystemName: pbx-01
Privilege: call,all
Channel: PJSIP/100-00000001
ChannelState: 0
ChannelStateDesc: Down
CallerIDNum: 100
CallerIDName: Alice
Uniqueid: 1705312200.1
```

`EntityID` is always present (auto-detected from the network interface MAC address, or set via `entityid` in `asterisk.conf`). `SystemName` is only included when `systemname` is configured in `asterisk.conf`.

The Kafka message key is set to the AMI event name (e.g., "Newchannel", "Hangup", "VarSet"), enabling natural partitioning by event type.

### Kafka Message Headers

Every published message includes Kafka-native headers that can be read without deserializing the payload:

| Header | Source | Example | Description |
|--------|--------|---------|-------------|
| `entity_id` | `ast_eid_default` | `"00:11:22:33:44:55"` | Identifies the Asterisk instance (multi-server). |
| `system_name` | `ast_config_AST_SYSTEM_NAME` | `"pbx-01"` | Human-readable name. Only sent if `systemname` is configured in `asterisk.conf`. |
| `asterisk_version` | `ast_get_version()` | `"22.2.0"` | Asterisk version string. |
| `event_type` | callback param | `"Newchannel"` | AMI event name (same as the message key). |
| `event_category` | callback param | `"call,reporting"` | Comma-separated EVENT_FLAG_* categories from the AMI bitmask. |
| `format` | config | `"json"` or `"ami"` | Tells consumers how to deserialize the payload. |
| `timestamp` | `time(NULL)` | `"1738108800"` | Unix epoch of the capture moment (before librdkafka enqueue). |
| `hostname` | `gethostname()` | `"asterisk-node-1"` | Machine hostname. Complements `system_name` in container/VM environments. |

These headers allow Kafka Streams, ksqlDB, and Connect SMTs to route and filter messages without parsing the body. The `entity_id` and `system_name` fields remain **also** in the payload for backward compatibility.

Verify headers with `kcat`:
```bash
kcat -C -b localhost:9092 -t asterisk_ami -f 'Headers: %h\nPayload: %s\n'
```

## Prerequisites

- Asterisk 18+ with Manager support
- [vsgroup-res_kafka](https://github.com/VirtualSistemas/vsgroup-res_kafka) (`res_kafka.so`)

## Building

Ensure `vsgroup-res_kafka` is checked out alongside this project:

```
parent/
├── vsgroup-res_kafka/
└── vsgroup-app_ami_kafka/
```

```bash
make
```

## Installation

```bash
make install
make samples
```

## Configuration

Edit `/etc/asterisk/ami_kafka.conf`:

```ini
[general]
enabled = yes
format = json              ; json or ami (default: json)

[kafka]
connection = my-kafka      ; Connection name from kafka.conf
topic = asterisk_ami       ; Kafka topic (default: asterisk_ami)
```

Make sure the connection name matches a `[connection]` section in your `kafka.conf` for `res_kafka`.

### Event Filtering

Without any filters, all AMI events are published. Filters use the same syntax as Asterisk `manager.conf`:

- **Include only** — only matching events are published
- **Exclude only** — all events except matching ones are published
- **Both** — include filters are evaluated first, then exclude rejects from the included set

**Legacy syntax** (regex applied to the full AMI body):
```ini
eventfilter = Event: Newchannel
eventfilter = !Channel: Local/
```

**Advanced syntax** (more efficient, avoids regex):
```ini
eventfilter(action(include),name(Newchannel)) =
eventfilter(action(include),name(Hangup)) =
eventfilter(action(exclude),header(Channel),method(starts_with)) = Local/
```

Available methods: `regex`, `exact`, `starts_with`, `ends_with`, `contains`, `none`.

### Configuration Options

| Option | Default | Description |
|--------|---------|-------------|
| `enabled` | `yes` | Enable or disable the module. |
| `format` | `json` | Output format: `json` or `ami`. |
| `eventfilter` | *(none)* | Event filter rules (multiple lines allowed). |
| `connection` | *(empty)* | Name of the connection from `kafka.conf`. Required. |
| `topic` | `asterisk_ami` | Kafka topic to publish events to. |

## Loading

```
asterisk -rx "module load res_kafka.so"
asterisk -rx "module load app_ami_kafka.so"
```

## Verifying

```bash
kafka-console-consumer --bootstrap-server localhost:9092 --topic asterisk_ami
```

Make a call and verify that events like `Newchannel`, `Hangup`, `VarSet`, etc. appear in the consumer output with `EntityID` identifying the source Asterisk instance.

## Architecture

```
asterisk.conf
    |  (entityid, systemname)
    v
app_ami_kafka.c          manager_custom_hook callback
    |                    Captures every AMI event, applies filters,
    |                    injects EntityID/SystemName, converts format,
    |                    attaches Kafka headers, and publishes via res_kafka
    v
ami_kafka.conf           ACO-based configuration (general + kafka sections)
```

| Component | Responsibility |
|-----------|---------------|
| `ami_hook_callback()` | Hot path — called synchronously under read-lock in `manager.c` for every AMI event. Applies filters, injects system identification, formats payload, builds 8 Kafka message headers, and calls `ast_kafka_produce_hdrs()` (non-blocking). |
| `ami_body_to_json()` | Parses AMI `"Key: Value\r\n"` pairs into an `ast_json` object. Injects `EntityID` and `SystemName` as the first fields after `Event`. |
| `should_send_event()` | Evaluates include/exclude filters against event name and body headers. |

## Project Structure

```
vsgroup-app_ami_kafka/
├── app_ami_kafka.c               Main module (hook, filters, format, config)
├── asterisk/
│   └── kafka.h                   Public API header from res_kafka
├── documentation/
│   └── app_ami_kafka_config-en_US.xml
├── ami_kafka.conf.sample         Sample configuration
├── Makefile
├── LICENSE                       GPLv2
└── AUTHORS
```

## License

GNU General Public License Version 2. See [LICENSE](LICENSE).
