# app_ami_kafka

Asterisk module that publishes all AMI (Asterisk Manager Interface) events to Apache Kafka via `res_kafka`.

## Overview

This module uses an internal manager hook (`manager_custom_hook`) to capture **every** AMI event generated by Asterisk and publishes them to a configurable Kafka topic. This eliminates the need for external AMI TCP connections while providing better throughput and native thread-safety.

### Output Formats

**JSON format** (`format = json`):
```json
{"Event": "Newchannel", "Privilege": "call,all", "Channel": "PJSIP/100-00000001", "ChannelState": "0", "ChannelStateDesc": "Down", "CallerIDNum": "100", "CallerIDName": "Alice", "Uniqueid": "1705312200.1"}
```

**AMI format** (`format = ami`):
```
Event: Newchannel
Privilege: call,all
Channel: PJSIP/100-00000001
ChannelState: 0
ChannelStateDesc: Down
CallerIDNum: 100
CallerIDName: Alice
Uniqueid: 1705312200.1
```

The Kafka message key is set to the AMI event name (e.g., "Newchannel", "Hangup", "VarSet"), enabling natural partitioning by event type.

## Prerequisites

- Asterisk 18+ with Manager support
- [vsgroup-res_kafka](https://github.com/VirtualSistemas/vsgroup-res_kafka) (`res_kafka.so`)

## Building

Ensure `vsgroup-res_kafka` is checked out alongside this project:

```
parent/
├── vsgroup-res_kafka/
└── vsgroup-app_ami_kafka/
```

```bash
make
```

## Installation

```bash
make install
make samples
```

## Configuration

Edit `/etc/asterisk/ami_kafka.conf`:

```ini
[general]
enabled = yes
format = json              ; json or ami (default: json)

[kafka]
connection = my-kafka      ; Connection name from kafka.conf
topic = asterisk_ami       ; Kafka topic (default: asterisk_ami)
```

Make sure the connection name matches a `[connection]` section in your
`kafka.conf` for `res_kafka`.

## Loading

```
asterisk -rx "module load res_kafka.so"
asterisk -rx "module load app_ami_kafka.so"
```

## Verifying

```bash
kafka-console-consumer --bootstrap-server localhost:9092 --topic asterisk_ami
```

Make a call and verify that events like `Newchannel`, `Hangup`, `VarSet`, etc. appear in the consumer output.

## License

GNU General Public License Version 2. See [LICENSE](LICENSE).
